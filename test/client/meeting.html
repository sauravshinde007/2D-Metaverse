<!DOCTYPE html>
<html>
<head>
  <title>Meeting Transcription</title>

  <script src="https://unpkg.com/@daily-co/daily-js"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial;
    }

    #call {
      width: 100vw;
      height: 90vh;
    }

    button {
      padding: 10px 20px;
      margin: 10px;
    }
  </style>
</head>

<body>

<h3>Meeting + Live Transcript</h3>

<button id="startBtn">Start Meeting</button>

<div id="call"></div>

<script>

const MEETING_URL = "https://sarang.daily.co/meta-room_12";

const socket = io("http://localhost:5000");

let call = null;
let audioCtx = null;


// =========================
document.getElementById("startBtn").onclick = async () => {

  // User gesture â†’ allow audio
  audioCtx = new AudioContext();

  await audioCtx.resume();

  startMeeting();
};


// =========================
function startMeeting() {

  call = Daily.createFrame({
    iframeStyle: {
      width: "100%",
      height: "100%",
      border: "0",
    },
  });

  document.getElementById("call").appendChild(call.iframe());

  call.join({ url: MEETING_URL });


  call.on("joined-meeting", () => {
    console.log("Joined meeting");
  });


  call.on("track-started", (e) => {

    if (e.track.kind === "audio") {
      console.log("Audio track started");
      handleAudio(e.track);
    }
  });
}


// =========================
function handleAudio(track) {

  const stream = new MediaStream([track]);

  const source =
    audioCtx.createMediaStreamSource(stream);

  const processor =
    audioCtx.createScriptProcessor(4096, 1, 1);

  source.connect(processor);
  processor.connect(audioCtx.destination);


  processor.onaudioprocess = (e) => {

    const input =
      e.inputBuffer.getChannelData(0);

    const downsampled = downsample(
      input,
      audioCtx.sampleRate,
      16000
    );

    socket.emit("audio", {
      chunk: Array.from(downsampled),
    });

    console.log("Sent:", downsampled.length);
  };
}


// =========================
function downsample(buffer, inRate, outRate) {

  if (inRate === outRate) return buffer;

  const ratio = inRate / outRate;

  const len = Math.round(buffer.length / ratio);

  const result = new Float32Array(len);

  for (let i = 0; i < len; i++) {

    let sum = 0;
    let count = 0;

    for (
      let j = Math.round(i * ratio);
      j < Math.round((i + 1) * ratio);
      j++
    ) {
      sum += buffer[j];
      count++;
    }

    result[i] = sum / count;
  }

  return result;
}

</script>

</body>
</html>
